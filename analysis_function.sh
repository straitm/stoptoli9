#!/bin/bash

set -o pipefail

if [ $macroparameter ]; then
  extrafilenamepart=_$macroparameter
fi
tmp=/tmp/$$.${name}_finalfit$extrafilenamepart.out 
macro=${name}_finalfit.C

finish(){
  name=$1
  out=${name}_finalfit$extrafilenamepart.out 
  headerout=${name}_finalfit$extrafilenamepart.out.h
  technoteout=${name}_finalfit$extrafilenamepart.out.technote
  figout=${name}_finalfit$extrafilenamepart.out.fig.h

  mv -f $tmp $out
  grep TECHNOTE $out > $technoteout

  if grep -q '^const ' $out; then
    printf '/* Automatically generated by %s analysis */\n' $name > $headerout
    grep '^const ' $out >> $headerout
  fi

  if grep -q '^FIGURE ' $out; then
    printf '/* Automatically generated by %s analysis */\n' $name > $figout
    grep '^FIGURE ' $out | sed 's/FIGURE //' >> $figout
  fi

  echo $name $macroparameter analysis finished sucessfully

  true # Always suceed
}

fail(){
  name=$1
  out=${name}_finalfit.out 
  mv -f $tmp $out.fail
  cat $out.fail
  exit 1
}
